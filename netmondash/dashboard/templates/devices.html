{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Network Devices</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-2">Monitor all devices on your network</p>
</div>

<!-- Device Count Summary -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="stat-card text-center">
        <div class="stat-label">Total</div>
        <div class="stat-value text-2xl" id="device-count-total">--</div>
    </div>
    <div class="stat-card text-center">
        <div class="stat-label">Online</div>
        <div class="stat-value text-2xl text-green-600" id="device-count-online">--</div>
    </div>
    <div class="stat-card text-center">
        <div class="stat-label">Offline</div>
        <div class="stat-value text-2xl text-red-600" id="device-count-offline">--</div>
    </div>
    <div class="stat-card text-center">
        <div class="stat-label">Avg Latency</div>
        <div class="stat-value text-2xl text-yellow-600" id="device-avg-latency">--</div>
    </div>
    <div class="stat-card text-center">
        <div class="stat-label">High Risk</div>
        <div class="stat-value text-2xl text-red-600" id="device-high-risk">--</div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-6">
    <div class="flex flex-wrap gap-4 items-center">
        <div>
            <label class="inline-flex items-center">
                <input type="checkbox" id="filter-online" class="form-checkbox" onchange="loadDevicesPage(1)">
                <span class="ml-2 dark:text-gray-300">Show online only</span>
            </label>
        </div>

        <!-- Category Filter -->
        <div>
            <select id="filter-category" class="form-select" onchange="loadDevicesPage(1)">
                <option value="">All Categories</option>
                <option value="computer">Computer</option>
                <option value="phone">Phone</option>
                <option value="tablet">Tablet</option>
                <option value="iot">IoT</option>
                <option value="router">Router</option>
                <option value="printer">Printer</option>
                <option value="media">Media</option>
                <option value="other">Other</option>
                <option value="unknown">Unknown</option>
            </select>
        </div>

        <!-- Sort by -->
        <div>
            <select id="sort-by" class="form-select" onchange="loadDevicesPage(currentDevicePage)">
                <option value="last_seen">Last Seen</option>
                <option value="ip">IP Address</option>
                <option value="hostname">Hostname</option>
                <option value="vendor">Vendor</option>
                <option value="risk_score">Risk Score</option>
                <option value="latency">Latency</option>
            </select>
        </div>
        <div>
            <select id="sort-order" class="form-select" onchange="loadDevicesPage(currentDevicePage)">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
            </select>
        </div>

        <div class="flex-1">
            <input
                type="text"
                id="search-devices"
                class="form-input w-full"
                placeholder="Search by IP, MAC, hostname, or vendor..."
                oninput="debouncedSearch()"
            >
        </div>

        <div class="flex gap-2">
            <button onclick="exportData('devices', 'csv')" class="btn-secondary">
                Export CSV
            </button>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulk-actions-bar" class="card mb-4 hidden">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <span class="text-sm font-medium dark:text-gray-300"><span id="bulk-selected-count">0</span> devices selected</span>
            <button onclick="bulkAction('trusted')" class="px-3 py-1.5 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                Mark Trusted
            </button>
            <button onclick="bulkAction('blocked')" class="px-3 py-1.5 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors">
                Mark Blocked
            </button>
            <button onclick="bulkAction('unset')" class="px-3 py-1.5 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors">
                Clear Status
            </button>
        </div>
        <button onclick="clearBulkSelection()" class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
            Clear Selection
        </button>
    </div>
</div>

<!-- Devices Table -->
<div class="card">
    <div class="overflow-x-auto">
        <table class="data-table" id="devices-table">
            <thead>
                <tr>
                    <th class="w-10">
                        <input type="checkbox" id="select-all-devices" class="form-checkbox" onchange="toggleSelectAll(this)">
                    </th>
                    <th>IP Address</th>
                    <th>MAC Address</th>
                    <th>Hostname</th>
                    <th>Vendor</th>
                    <th>Category</th>
                    <th>Open Ports</th>
                    <th>Latency</th>
                    <th>Risk</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="devices-tbody">
                <tr>
                    <td colspan="12" class="text-center text-gray-500">Loading devices...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- Pagination -->
    <div id="devices-pagination" class="mt-4"></div>
</div>

<!-- Device Details Modal -->
<div id="device-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 750px;">
        <div class="modal-header">
            <h3 class="text-xl font-bold dark:text-gray-100">Device Details</h3>
            <button onclick="closeDeviceModal()" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">&times;</button>
        </div>
        <div class="modal-body" id="device-details">
            <!-- Populated dynamically -->
        </div>

        <!-- Tabs for extra info -->
        <div class="px-6 pb-4">
            <div class="flex space-x-4 border-b border-gray-200 dark:border-gray-700 mb-3">
                <button onclick="showDeviceTab('events')" id="tab-events" class="py-2 px-1 text-sm font-medium border-b-2 border-blue-600 text-blue-600">Events</button>
                <button onclick="showDeviceTab('changelog')" id="tab-changelog" class="py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Changelog</button>
                <button onclick="showDeviceTab('uptime')" id="tab-uptime" class="py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Uptime</button>
            </div>
            <div id="device-tab-events" class="space-y-2 max-h-48 overflow-y-auto">
                <div class="text-sm text-gray-500">Loading events...</div>
            </div>
            <div id="device-tab-changelog" class="space-y-2 max-h-48 overflow-y-auto hidden">
                <div class="text-sm text-gray-500">Loading changelog...</div>
            </div>
            <div id="device-tab-uptime" class="space-y-2 max-h-48 overflow-y-auto hidden">
                <div class="text-sm text-gray-500">Loading uptime...</div>
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="closeDeviceModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_init %}
loadDevicesPage(1);
{% endblock %}

{% block extra_scripts %}
<script>
let devicesData = [];
let selectedDevices = new Set();
let currentDevicePage = 1;
let totalDevicePages = 1;
const devicesPerPage = 25;

const debouncedSearch = debounce(function() {
    loadDevicesPage(1);
}, 300);

async function loadDevicesPage(page) {
    currentDevicePage = page;
    try {
        const onlineOnly = document.getElementById('filter-online').checked;
        const search = document.getElementById('search-devices').value;
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;

        let url = `/api/devices?page=${page}&per_page=${devicesPerPage}&sort_by=${sortBy}&sort_order=${sortOrder}`;
        if (onlineOnly) url += '&online_only=true';
        if (search) url += '&search=' + encodeURIComponent(search);

        const response = await fetch(url);
        const data = await response.json();

        if (data.devices) {
            devicesData = data.devices;
            totalDevicePages = data.total_pages || Math.ceil((data.total || data.devices.length) / devicesPerPage);
            renderDevicesTable(devicesData);
            renderPagination('devices-pagination', currentDevicePage, totalDevicePages, 'loadDevicesPage');
        } else if (data.items) {
            devicesData = data.items;
            totalDevicePages = data.total_pages || 1;
            renderDevicesTable(devicesData);
            renderPagination('devices-pagination', currentDevicePage, totalDevicePages, 'loadDevicesPage');
        }

        // Update counts
        updateDeviceCounts();

    } catch (error) {
        console.error('Error loading devices:', error);
        showNotification('Failed to load devices', 'error');
    }
}

function loadDevices() { loadDevicesPage(1); }

async function updateDeviceCounts() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        document.getElementById('device-count-total').textContent = stats.total_devices || 0;
        document.getElementById('device-count-online').textContent = stats.online_devices || 0;
        document.getElementById('device-count-offline').textContent = (stats.total_devices || 0) - (stats.online_devices || 0);
        if (stats.avg_latency !== undefined) {
            document.getElementById('device-avg-latency').textContent = stats.avg_latency.toFixed(1) + ' ms';
        }
        if (stats.high_risk_count !== undefined) {
            document.getElementById('device-high-risk').textContent = stats.high_risk_count;
        }
    } catch (e) {}
}

function getCategoryBadge(category) {
    const catColors = {
        'computer': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
        'phone': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
        'tablet': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300',
        'iot': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
        'router': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300',
        'printer': 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-300',
        'media': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300',
        'other': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
        'unknown': 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400',
    };
    const cat = (category || 'unknown').toLowerCase();
    const colorClass = catColors[cat] || catColors['unknown'];
    return `<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${colorClass}">${category || 'Unknown'}</span>`;
}

function renderDevicesTable(devices) {
    const tbody = document.getElementById('devices-tbody');
    tbody.innerHTML = '';

    if (devices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-gray-500">No devices found</td></tr>';
        return;
    }

    devices.forEach(device => {
        const row = tbody.insertRow();
        const isSelected = selectedDevices.has(device.mac);
        row.className = isSelected ? 'bg-blue-50 dark:bg-blue-900/20' : '';
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-checkbox device-select" data-mac="${device.mac}"
                    ${isSelected ? 'checked' : ''} onchange="toggleDeviceSelect('${device.mac}', this.checked)">
            </td>
            <td class="font-mono">${device.ip}</td>
            <td class="font-mono text-sm">${device.mac}</td>
            <td>${device.hostname || '<span class="text-gray-400">Unknown</span>'}</td>
            <td>${device.vendor || '<span class="text-gray-400">Unknown</span>'}</td>
            <td>${getCategoryBadge(device.category)}</td>
            <td>
                ${device.open_ports && device.open_ports.length > 0
                    ? `<span class="text-sm">${device.open_ports.slice(0, 3).join(', ')}${device.open_ports.length > 3 ? '...' : ''}</span>`
                    : '<span class="text-gray-400">None</span>'}
            </td>
            <td class="text-sm">
                ${device.latency !== undefined && device.latency !== null
                    ? `<span class="${device.latency < 10 ? 'text-green-600' : device.latency < 50 ? 'text-yellow-600' : 'text-red-600'}">${device.latency.toFixed(1)} ms</span>`
                    : '<span class="text-gray-400">--</span>'}
            </td>
            <td>${renderRiskBadge(device.risk_score)}</td>
            <td class="text-sm">${formatTimeAgo(new Date(device.last_seen))}</td>
            <td>
                <span class="status-badge status-${device.is_online ? 'online' : 'offline'}">
                    ${device.is_online ? 'Online' : 'Offline'}
                </span>
            </td>
            <td>
                <button onclick='showDeviceDetails("${device.mac}")' class="text-blue-600 hover:text-blue-800 text-sm">
                    Details
                </button>
            </td>
        `;
    });
}

// Bulk selection
function toggleDeviceSelect(mac, checked) {
    if (checked) selectedDevices.add(mac);
    else selectedDevices.delete(mac);
    updateBulkActionsBar();
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.device-select').forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) selectedDevices.add(cb.dataset.mac);
        else selectedDevices.delete(cb.dataset.mac);
    });
    updateBulkActionsBar();
}

function clearBulkSelection() {
    selectedDevices.clear();
    document.querySelectorAll('.device-select').forEach(cb => cb.checked = false);
    document.getElementById('select-all-devices').checked = false;
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const bar = document.getElementById('bulk-actions-bar');
    document.getElementById('bulk-selected-count').textContent = selectedDevices.size;
    if (selectedDevices.size > 0) bar.classList.remove('hidden');
    else bar.classList.add('hidden');
}

async function bulkAction(action) {
    if (selectedDevices.size === 0) return;
    const macs = Array.from(selectedDevices);
    let successCount = 0;
    for (const mac of macs) {
        try {
            const response = await fetch(`/api/devices/${mac}/trust`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: action })
            });
            if (response.ok) successCount++;
        } catch (e) { console.error(`Failed to update ${mac}:`, e); }
    }
    showNotification(`Updated ${successCount} of ${macs.length} devices to "${action}"`, 'success');
    clearBulkSelection();
    loadDevicesPage(currentDevicePage);
}

// Device modal tabs
function showDeviceTab(tab) {
    ['events', 'changelog', 'uptime'].forEach(t => {
        document.getElementById('device-tab-' + t).classList.toggle('hidden', t !== tab);
        const tabBtn = document.getElementById('tab-' + t);
        if (t === tab) {
            tabBtn.className = 'py-2 px-1 text-sm font-medium border-b-2 border-blue-600 text-blue-600';
        } else {
            tabBtn.className = 'py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
        }
    });
}

async function showDeviceDetails(mac) {
    try {
        const response = await fetch(`/api/devices/${mac}`);
        const device = await response.json();

        const trustStatus = device.trust_status || 'unset';
        const detailsDiv = document.getElementById('device-details');
        detailsDiv.innerHTML = `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="detail-label">IP Address</label>
                        <div class="detail-value font-mono">${device.ip}</div>
                    </div>
                    <div>
                        <label class="detail-label">MAC Address</label>
                        <div class="detail-value font-mono">${device.mac}</div>
                    </div>
                    <div>
                        <label class="detail-label">Hostname</label>
                        <div class="detail-value">${device.hostname || 'Unknown'}</div>
                    </div>
                    <div>
                        <label class="detail-label">Vendor</label>
                        <div class="detail-value">${device.vendor || 'Unknown'}</div>
                    </div>
                    <div>
                        <label class="detail-label">Category</label>
                        <div class="detail-value">${getCategoryBadge(device.category)}</div>
                    </div>
                    <div>
                        <label class="detail-label">Risk Score</label>
                        <div class="detail-value">${renderRiskBadge(device.risk_score)}</div>
                    </div>
                    <div>
                        <label class="detail-label">Latency</label>
                        <div class="detail-value">${device.latency !== undefined && device.latency !== null ? device.latency.toFixed(1) + ' ms' : 'N/A'}${device.jitter_ms ? ' (jitter: ' + device.jitter_ms.toFixed(1) + ' ms)' : ''}</div>
                    </div>
                    <div>
                        <label class="detail-label">Packet Loss</label>
                        <div class="detail-value">${device.packet_loss !== undefined && device.packet_loss !== null ? device.packet_loss.toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                    <div>
                        <label class="detail-label">First Seen</label>
                        <div class="detail-value">${formatDateTime(new Date(device.first_seen))}</div>
                    </div>
                    <div>
                        <label class="detail-label">Last Seen</label>
                        <div class="detail-value">${formatDateTime(new Date(device.last_seen))}</div>
                    </div>
                </div>

                ${device.open_ports && device.open_ports.length > 0 ? `
                <div>
                    <label class="detail-label">Open Ports</label>
                    <div class="detail-value">
                        ${device.open_ports.map(port => {
                            const service = device.services ? (device.services[port] || 'unknown') : 'unknown';
                            return `<span class="port-badge">${port} (${service})</span>`;
                        }).join(' ')}
                    </div>
                </div>
                ` : ''}

                <!-- Trust/Block Controls -->
                <div>
                    <label class="detail-label">Device Trust Status</label>
                    <div class="flex space-x-2 mt-1">
                        <button onclick='setDeviceTrust("${device.mac}", "trusted")' class="px-4 py-2 rounded text-sm font-medium transition-colors ${trustStatus === 'trusted' ? 'bg-green-600 text-white ring-2 ring-green-400' : 'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-green-900'}">
                            Trusted
                        </button>
                        <button onclick='setDeviceTrust("${device.mac}", "blocked")' class="px-4 py-2 rounded text-sm font-medium transition-colors ${trustStatus === 'blocked' ? 'bg-red-600 text-white ring-2 ring-red-400' : 'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-300 hover:bg-red-100 dark:hover:bg-red-900'}">
                            Blocked
                        </button>
                        <button onclick='setDeviceTrust("${device.mac}", "unset")' class="px-4 py-2 rounded text-sm font-medium transition-colors ${trustStatus === 'unset' ? 'bg-blue-600 text-white ring-2 ring-blue-400' : 'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500'}">
                            Unset
                        </button>
                    </div>
                </div>

                <!-- Custom Name -->
                <div>
                    <label class="detail-label">Custom Name</label>
                    <div class="flex space-x-2">
                        <input type="text" id="device-custom-name" class="form-input flex-1" placeholder="Give this device a friendly name..."
                            value="${device.custom_name || ''}">
                        <button onclick='saveDeviceCustomName("${device.mac}")' class="btn-primary text-sm">Save Name</button>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="detail-label">Notes</label>
                    <textarea id="device-notes" class="form-textarea w-full" rows="3" placeholder="Add notes about this device...">${device.notes || ''}</textarea>
                    <button onclick='saveDeviceNotes("${device.mac}")' class="btn-primary mt-2 text-sm">Save Notes</button>
                </div>
            </div>
        `;

        document.getElementById('device-modal').classList.remove('hidden');
        showDeviceTab('events');
        loadDeviceEvents(mac);
        loadDeviceChangelog(mac);
        loadDeviceUptime(mac);

    } catch (error) {
        console.error('Error loading device details:', error);
        showNotification('Failed to load device details', 'error');
    }
}

async function loadDeviceEvents(mac) {
    const container = document.getElementById('device-tab-events');
    try {
        const response = await fetch(`/api/events/${mac}`);
        if (!response.ok) { container.innerHTML = '<div class="text-sm text-gray-500">No event history available</div>'; return; }
        const data = await response.json();
        const events = data.events || data || [];
        container.innerHTML = '';
        if (events.length === 0) { container.innerHTML = '<div class="text-sm text-gray-500">No events recorded</div>'; return; }
        events.slice(0, 15).forEach(event => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 text-sm p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700';
            div.innerHTML = `
                <div class="w-2 h-2 rounded-full ${event.type === 'online' ? 'bg-green-500' : event.type === 'offline' ? 'bg-red-500' : 'bg-blue-500'}"></div>
                <span class="flex-1 dark:text-gray-300">${event.description || event.message || event.type || 'Event'}</span>
                <span class="text-xs text-gray-500">${event.timestamp ? formatTimeAgo(new Date(event.timestamp)) : ''}</span>
            `;
            container.appendChild(div);
        });
    } catch (error) {
        container.innerHTML = '<div class="text-sm text-gray-500">Could not load events</div>';
    }
}

async function loadDeviceChangelog(mac) {
    const container = document.getElementById('device-tab-changelog');
    try {
        const response = await fetch(`/api/devices/${mac}/changelog`);
        if (!response.ok) { container.innerHTML = '<div class="text-sm text-gray-500">No changelog available</div>'; return; }
        const data = await response.json();
        const changes = data.changes || data || [];
        container.innerHTML = '';
        if (changes.length === 0) { container.innerHTML = '<div class="text-sm text-gray-500">No changes recorded</div>'; return; }
        changes.slice(0, 20).forEach(change => {
            const div = document.createElement('div');
            div.className = 'text-sm p-2 rounded bg-gray-50 dark:bg-gray-800';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <span class="font-medium dark:text-gray-200">${change.field || 'unknown'}</span>:
                        <span class="text-gray-500">${change.old_value || '--'}</span> &rarr;
                        <span class="text-blue-600 dark:text-blue-400">${change.new_value || '--'}</span>
                    </div>
                    <span class="text-xs text-gray-400 ml-2 flex-shrink-0">${change.timestamp ? formatTimeAgo(new Date(change.timestamp)) : ''}</span>
                </div>
            `;
            container.appendChild(div);
        });
    } catch (error) {
        container.innerHTML = '<div class="text-sm text-gray-500">Could not load changelog</div>';
    }
}

async function loadDeviceUptime(mac) {
    const container = document.getElementById('device-tab-uptime');
    try {
        const response = await fetch(`/api/devices/${mac}/uptime`);
        if (!response.ok) { container.innerHTML = '<div class="text-sm text-gray-500">No uptime data</div>'; return; }
        const data = await response.json();
        const records = data.records || data.uptime || data || [];
        container.innerHTML = '';
        if (records.length === 0 && !data.uptime_percent) {
            container.innerHTML = '<div class="text-sm text-gray-500">No uptime records</div>';
            return;
        }
        if (data.uptime_percent !== undefined) {
            const pct = data.uptime_percent;
            const barColor = pct >= 99 ? 'bg-green-500' : pct >= 95 ? 'bg-yellow-500' : 'bg-red-500';
            container.innerHTML += `
                <div class="mb-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="dark:text-gray-300">Uptime (7d)</span>
                        <span class="font-semibold dark:text-gray-200">${pct.toFixed(2)}%</span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full ${barColor} rounded-full" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }
        if (Array.isArray(records)) {
            records.slice(0, 10).forEach(rec => {
                const div = document.createElement('div');
                const statusClass = rec.status === 'online' ? 'text-green-600' : 'text-red-600';
                div.className = 'flex items-center justify-between text-sm p-1';
                div.innerHTML = `
                    <span class="${statusClass} font-medium">${rec.status || 'unknown'}</span>
                    <span class="text-gray-500">${rec.duration ? formatDuration(rec.duration) : ''}</span>
                    <span class="text-xs text-gray-400">${rec.timestamp ? formatTimeAgo(new Date(rec.timestamp)) : ''}</span>
                `;
                container.appendChild(div);
            });
        }
    } catch (error) {
        container.innerHTML = '<div class="text-sm text-gray-500">Could not load uptime data</div>';
    }
}

async function setDeviceTrust(mac, status) {
    try {
        const response = await fetch(`/api/devices/${mac}/trust`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status })
        });
        if (response.ok) {
            showNotification(`Device marked as ${status}`, 'success');
            showDeviceDetails(mac);
            loadDevicesPage(currentDevicePage);
        } else {
            showNotification('Failed to update trust status', 'error');
        }
    } catch (error) {
        showNotification('Failed to update trust status', 'error');
    }
}

async function saveDeviceCustomName(mac) {
    try {
        const customName = document.getElementById('device-custom-name').value;
        const response = await fetch(`/api/devices/${mac}/name`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ custom_name: customName })
        });
        if (response.ok) {
            showNotification('Custom name saved', 'success');
            loadDevicesPage(currentDevicePage);
        } else {
            showNotification('Failed to save custom name', 'error');
        }
    } catch (error) {
        showNotification('Failed to save custom name', 'error');
    }
}

async function saveDeviceNotes(mac) {
    try {
        const notes = document.getElementById('device-notes').value;
        const response = await fetch(`/api/devices/${mac}/notes`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes })
        });
        if (response.ok) showNotification('Notes saved successfully', 'success');
        else showNotification('Failed to save notes', 'error');
    } catch (error) {
        showNotification('Failed to save notes', 'error');
    }
}

function closeDeviceModal() {
    document.getElementById('device-modal').classList.add('hidden');
}
</script>
{% endblock %}
